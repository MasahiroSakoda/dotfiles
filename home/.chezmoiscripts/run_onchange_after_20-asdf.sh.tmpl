#!/usr/bin/env bash
# -*-mode:sh-*- vim:ft=sh

set -eo pipefail

{{ template "common/script_eval_brew" . }}

. "$(brew --prefix asdf)/libexec/asdf.sh"

export CONFIGURE_OPTS="-with-openssl=$(brew --prefix openssl@3)"
export CPPFLAGS="-I$(brew --prefix openssl)/include"
export LDFLAGS="-L$(brew --prefix openssl)/lib"

export RUBY_CONFIGURE_OPTS="--with-openssl-dir=$(brew --prefix openssl@3)"

# install from ~/.tool-versions
while read plugin version; do
  if asdf plugin-list | grep --silent $plugin; then
    echo "asdf plugin \"${plugin}\" is already installed"
    echo "asdf plugin \"${plugin}\" updating..."
    asdf plugin-update ${plugin}
  else
    echo "installing ${plugin}..."
    asdf plugin-add ${plugin}
  fi

  if ! asdf current ${python} | grep -Fq ${version}; then
    asdf install ${plugin} ${version}
    echo "${plugin} installed to $(which ${plugin})"

    asdf global ${plugin} ${version}
  fi
  asdf reshim ${plugin} ${version}
  echo "${plugin} ${version} is activated"
done < ~/.tool-versions

# pnpm completion for fish
$(command -v pnpm) install-completion fish || true

asdf current
